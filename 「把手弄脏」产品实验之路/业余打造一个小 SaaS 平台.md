嗯，要自己业余做一个，毕竟目前工作的业务也是和 SaaS 平台相关的。最近一直在全力扑在工作上的事情，有点忙的焦头烂额。眼看快要过年，对于业务的理解目前个人理解还有点肤浅，一些事情还是没有考虑清楚的，希望能够通过动手深入到内部去实践一下了解更多内容，以便于未来工作上的沟通，并能够在这个过程中学到更多东西。

## 订单设计 

### 02.03

最近开始好好设计和规划这个小 SaaS 平台系统，计划是先完成一个商城基础功能（简化版本天猫）。目前涉及的用户系统、客户系统（租户）、商品管理基本已经理清。下午在床上撸码，订单问题让我有点困惑，看起来订单和产品的关系应该是多对多的，类似经典教程里面的书籍与作者的关系：一本书籍可以后多位作者，一位作者可以编写多本书籍。这里面的共同点是：一个订单可以包含多个产品，一个产品可以出现在多个不同的订单内。但是区别在于：一个订单内的包含的产品，其中一项产品，可以不只是有一件，就像我们平时去超市买东西，我不可能只买一个苹果、一根香蕉、一个橙子。个人习惯是买 6 个苹果、一串香蕉（可能 5 个）、10 个橙子。在这里显然纯粹的多对多关系是不能满足需求的了。今天气温不到 10℃，感觉到这里没有明白，于是就睡过去了（=_=）。

可能是自己思路比较窄，一直觉得似乎要在多对多的基础上打补丁，增加一些数据，比如我存储一个字典到订单中，对应某个 ID 的产品用户下了多少数量，序列化后存储到数据库中，做法看起来很不「优雅」。而且未来维护起来也有一些问题，比如将来需要加入一些对于客户已经销售商品的统计，实时输出统计数据的需求处理起来相对复杂，对资源的要求比较高。如果系统部署在 AWS Lambda 平台上，可能会有实现的局限。所以这种方式还是不合适的。刚才搜索了一些资料，有一篇文章中提到的设计刚好解决这个问题：[链接地址](http://blog.csdn.net/cocosstudio/article/details/72654928) 。文中提到，其实订单之类的也可以看作是一对多关系，一个订单对应多个订单项。按照这个思路，一个订单项对应一个产品，并附带记录该产品的订单数量。如此一来将维度分解一下，问题迎刃而解，真的很感谢这位分享思路的同学 >_<。

> 另外，看到这篇文章的时候感觉 CSDN 的设计有些不合理的地方，平时我是不泡这个平台的，也就是说我浏览的时候不会处于登陆状态。非常想留言向这位作者说一声谢谢，但是网站要求 `目前您尚未登录，请 登录 或 注册 后进行评论`。我觉得为了对作者表达一句感激再找一下登陆账号或者注册一个，实在是有点过于麻烦。我在想，平台这么做，是否也会打击作者的积极性呢，先前写博客，感受到有阅读者的鼓励和留言是一件很能够激励作者的事情。平台的这种限定，应该是对用户创造内容积极性的一种限制吧。当然，因为一些内容可控性的问题，国内网站这样去做处理也是情有可原的。

对于订单项的设计，包含关联产品和产品数量外，增加关联 app 和关联用户。这样做的目的，是为了满足未来版本的统计需求，如：统计某个商户的某款产品的总体销售情况、用户购买分布；统计某个用户某款产品的购买量、购买产品喜好等数据。我想这应该不算是过度设计，前期添加后记录相关数据，未来功能的增加和升级会相对平缓一些。

补充，每个订单项增加一个价格字段（price），实际应用场景，用户订单某个单品的最终结算价格可能涉及到优惠折扣、活动价格，如买一赠一、五折优惠等，需要单独标注，界面还可能对照进行呈现，所以在实现上也需要特别注意。

### 02.04 11:18
昨晚在订单的创建逻辑上小纠结了一下，写了差不多 70 行代码才搞定，对于 Python 还不是很熟的感觉。测试用例还没有添加特殊情况的测试，今天要补充一下。

刚刚在编写订单删除逻辑的时候，下意识的先写了一个物理删除的版本。写完就感觉不太对了，应该去做逻辑删除更合适一些，如果用户误操作，商户和管理平台在后台无法查找历史数据就糟糕了。看到 [链接](https://segmentfault.com/q/1010000009645538/a-1020000009645576) 有提到关于这两种方式的权衡考虑：

- 逻辑删除：即标记删除，设置一个状态字段，判断删除，该类删除主要使用于一些，用户删除，但是可能网站还会使用到的一些数据，也包含，用户删除以后还想去恢复的一部分数据。
- 物理删除：即直接删除该数据。这类的删除适用于使用之后，无意义的数据，比如我们现在注册发送的验证码等类型的数据。
- 其实我们数据不做物理删除，我们也是为了以后能更好的勾勒出用户在本站的信息图谱（包括爱好，住址，曾发布，浏览历史等等），说白了，就是有利于我们分析用户行为的数据都不要做物理删除！

所以，考虑到实际的应用场景，订单需要在现在的版本上，将物理删除修改为逻辑删除，这个接口是用户端掉用的（网页/APP），同时还要增加一个接口，是用来给商家、管理平台使用的用于恢复订单状态（恢复删除）使用。



## 自动化测试

这个项目的后端开发从上周开始引入了自动化测试，Django 的框架设计感觉不逊于 RoR。刚起步的时候，引入 REST framework 库开始编写接口，使用浏览器和 postman 进行调试，感觉效率很低，而且有大量重复劳动在里面。记得当时一开始 RoR 的时候，跟着教程走测试还是很爽的，于是看了一下文档说明，慢慢适应了起来。现在编写功能的时候已经开始不打开浏览器和 postman 工具了。

刚才配置好了 PyCharm 的 Django Test 环境，`Shift+F10` 一键测试，感觉非常顺畅。